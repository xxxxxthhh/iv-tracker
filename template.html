<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IV Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;padding:0}
a{color:#58a6ff;text-decoration:none}
a:hover{text-decoration:underline}

/* Nav */
nav{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #21262d;background:#161b22}
nav h1{font-size:20px;color:#58a6ff}
nav .links{display:flex;gap:16px;font-size:13px}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:24px}

/* Cards */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:24px}
.card{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:14px}
.card .lb{color:#8b949e;font-size:11px;text-transform:uppercase;margin-bottom:4px}
.card .val{font-size:22px;font-weight:700}

/* Colors */
.g{color:#3fb950}.r{color:#f85149}.b{color:#58a6ff}.y{color:#d29922}.gr{color:#8b949e}

/* Section */
h2{color:#8b949e;font-size:15px;margin:20px 0 12px;border-bottom:1px solid #21262d;padding-bottom:6px}

/* Table */
table{width:100%;border-collapse:collapse;background:#161b22;border:1px solid #21262d;border-radius:8px;overflow:hidden;font-size:13px}
th{background:#21262d;color:#8b949e;font-size:11px;text-transform:uppercase;padding:8px 10px;text-align:left;cursor:pointer;user-select:none;white-space:nowrap}
th:hover{color:#c9d1d9}
th .arrow{font-size:10px;margin-left:2px}
td{padding:8px 10px;border-top:1px solid #21262d}
tr.clickable:hover{background:#1c2128;cursor:pointer}

/* Tags */
.tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.tag-hot{background:#2d0000;color:#f85149}
.tag-rich{background:#2d1b00;color:#d29922}
.tag-fair{background:#0d2818;color:#3fb950}
.tag-cheap{background:#1c1c1c;color:#8b949e}

/* Score bar */
.score-bar{width:60px;height:8px;background:#21262d;border-radius:4px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:6px}
.score-fill{height:100%;border-radius:4px}

/* Detail panel */
#detail{display:none;margin-top:24px;background:#161b22;border:1px solid #21262d;border-radius:8px;padding:20px}
#detail .close-btn{float:right;background:none;border:1px solid #30363d;color:#8b949e;border-radius:6px;padding:4px 12px;cursor:pointer;font-size:12px}
#detail .close-btn:hover{color:#c9d1d9;border-color:#8b949e}
#detail h3{font-size:18px;color:#58a6ff;margin-bottom:16px}
.detail-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:20px}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.chart-box{background:#0d1117;border:1px solid #21262d;border-radius:8px;padding:12px;position:relative;height:280px}
.chart-box canvas{width:100%!important;height:100%!important}

/* Chain table */
#chain-wrap{max-height:400px;overflow-y:auto;border-radius:8px}
#chain-wrap table{font-size:12px}
#chain-wrap th{position:sticky;top:0;z-index:1}

/* Bar chart section */
.bar-section{margin:24px 0}
.bar-chart-wrap{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:16px;height:360px;position:relative}
.bar-chart-wrap canvas{width:100%!important;height:100%!important}

/* Footer */
.footer{text-align:center;color:#484f58;font-size:11px;padding:24px 0;border-top:1px solid #21262d;margin-top:32px}

/* Weekly section */
.weekly-symbol{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:16px;margin-bottom:16px}
.weekly-symbol h3{color:#58a6ff;font-size:16px;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.weekly-symbol h3 .iv-badge{font-size:12px;padding:2px 8px;border-radius:10px;font-weight:600}
.weekly-expiry{margin-bottom:16px}
.weekly-expiry h4{color:#8b949e;font-size:13px;margin-bottom:8px}
.opp-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px}
.opp-box{background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:12px}
.opp-box h5{color:#8b949e;font-size:11px;text-transform:uppercase;margin-bottom:8px}
.opp-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:12px;border-bottom:1px solid #161b22}
.opp-row:last-child{border-bottom:none}
.opp-row .strike{font-weight:600;color:#c9d1d9}
.opp-row .premium{color:#3fb950;font-weight:600}
.opp-row .ann{color:#d29922;font-size:11px}
.opp-row .meta{color:#8b949e;font-size:11px}
.term-struct{display:flex;gap:16px;margin-bottom:12px}
.term-struct .ts-item{background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:8px 14px;text-align:center;flex:1}
.term-struct .ts-dte{color:#8b949e;font-size:11px}
.term-struct .ts-iv{font-size:18px;font-weight:700}

/* Tabs */
.tabs{display:flex;gap:0;margin-bottom:20px;border-bottom:2px solid #21262d}
.tab-btn{background:none;border:none;color:#8b949e;font-size:14px;padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500}
.tab-btn:hover{color:#c9d1d9}
.tab-btn.active{color:#58a6ff;border-bottom-color:#58a6ff}

/* Responsive */
@media(max-width:768px){
  .charts-row{grid-template-columns:1fr}
  .cards{grid-template-columns:repeat(2,1fr)}
  nav{flex-direction:column;gap:8px}
}

/* Screener tracked badge */
.badge-tracked{display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:600;background:#0d2818;color:#3fb950;margin-left:4px}
.badge-new{display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;font-weight:600;background:#2d1b00;color:#d29922;margin-left:4px}
</style>
</head>
<body>

<nav>
  <h1>ğŸ´ IV Tracker</h1>
  <div class="links">
    <a href="https://xxxxxthhh.github.io/cc-dashboard/">ğŸ”’ CC Dashboard â†’</a>
  </div>
</nav>

<div class="container">
  <div class="cards" id="summary"></div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('scanner')">ğŸ“Š IV Scanner</button>
    <button class="tab-btn" onclick="switchTab('weekly')">ğŸ”„ Weekly Trading</button>
    <button class="tab-btn" onclick="switchTab('screener')">ğŸ” Screener</button>
  </div>

  <div id="scanner-tab">
  <h2>ğŸ“Š IV Scanner â€” Wheel å€™é€‰æ± </h2>
  <table id="scanner">
    <thead><tr>
      <th data-col="tk">æ ‡çš„</th>
      <th data-col="px" data-num>è‚¡ä»·</th>
      <th data-col="iv" data-num>ATM IV</th>
      <th data-col="hv20" data-num>HV20</th>
      <th data-col="ratio" data-num>IV/HV</th>
      <th data-col="pct" data-num>IV %ile</th>
      <th data-col="dte" data-num>DTE</th>
      <th data-col="sc" data-num>æœºä¼šè¯„åˆ†</th>
      <th>ä¿¡å·</th>
    </tr></thead>
    <tbody id="scanner-body"></tbody>
  </table>

  <div class="bar-section">
    <h2>ğŸ“ˆ IV æ°´å¹³å¯¹æ¯”</h2>
    <div class="bar-chart-wrap"><canvas id="ivBarChart"></canvas></div>
  </div>

  </div><!-- /scanner-tab -->

  <div id="weekly" style="display:none">
    <h2>ğŸ”„ Weekly Trading â€” è¿‘æœŸæœŸæƒæœºä¼š (7-14 DTE)</h2>
    <div id="weekly-content"></div>
  </div>

  <div id="screener-tab" style="display:none">
    <h2>ğŸ” å…¨å¸‚åœº IV Screener â€” yfinance æ•°æ®</h2>
    <div id="screener-meta" class="gr" style="font-size:12px;margin-bottom:12px"></div>
    <div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
      <label class="gr" style="font-size:12px">æœ€ä½ IV:</label>
      <select id="scr-min-iv" onchange="renderScreener()" style="background:#21262d;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:4px 8px;font-size:12px">
        <option value="0.30">30%</option>
        <option value="0.40" selected>40%</option>
        <option value="0.50">50%</option>
        <option value="0.60">60%</option>
        <option value="0.70">70%</option>
      </select>
      <label class="gr" style="font-size:12px;margin-left:8px">æœ€é«˜è‚¡ä»·:</label>
      <select id="scr-max-price" onchange="renderScreener()" style="background:#21262d;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:4px 8px;font-size:12px">
        <option value="50">$50</option>
        <option value="100">$100</option>
        <option value="200">$200</option>
        <option value="500" selected>$500</option>
        <option value="99999">ä¸é™</option>
      </select>
      <label class="gr" style="font-size:12px;margin-left:8px">æœ€ä½ OI:</label>
      <select id="scr-min-oi" onchange="renderScreener()" style="background:#21262d;color:#c9d1d9;border:1px solid #30363d;border-radius:4px;padding:4px 8px;font-size:12px">
        <option value="0">ä¸é™</option>
        <option value="100" selected>100</option>
        <option value="1000">1K</option>
        <option value="10000">10K</option>
        <option value="50000">50K</option>
      </select>
    </div>
    <table id="screener-table">
      <thead><tr>
        <th data-scol="ticker">æ ‡çš„</th>
        <th data-scol="price" data-num>è‚¡ä»·</th>
        <th data-scol="atm_iv" data-num>ATM IV</th>
        <th data-scol="open_interest" data-num>OI</th>
        <th data-scol="csp_ann_pct" data-num>CSP å¹´åŒ–</th>
        <th data-scol="dte" data-num>DTE</th>
        <th>ä¿¡å·</th>
        <th>çŠ¶æ€</th>
      </tr></thead>
      <tbody id="screener-body"></tbody>
    </table>
  </div>

  <div id="detail">
    <button class="close-btn" onclick="closeDetail()">âœ• å…³é—­</button>
    <h3 id="detail-title"></h3>
    <div class="detail-cards" id="detail-cards"></div>
    <div class="charts-row">
      <div class="chart-box"><canvas id="hvChart"></canvas></div>
      <div class="chart-box"><canvas id="smileChart"></canvas></div>
    </div>
    <h2>ğŸ“‹ æœŸæƒé“¾ (30-45 DTE)</h2>
    <div id="chain-wrap"><table id="chain">
      <thead><tr><th>Type</th><th>Strike</th><th>IV</th><th>Delta</th><th>Theta</th><th>Vega</th><th>Bid</th><th>Ask</th><th>Volume</th><th>OI</th></tr></thead>
      <tbody id="chain-body"></tbody>
    </table></div>
  </div>

  <div class="footer">
    IV Tracker Â· æ•°æ®æ¥æº Futu OpenD Â· ç”Ÿæˆäº <span id="gen-time"></span>
  </div>
</div>

<script>
const D = /*__DATA__*/"placeholder";

// â”€â”€ Helpers â”€â”€
const fmt = (n,d=2) => n==null?'â€”':n.toFixed(d);
const fmtPct = n => n==null?'â€”':(n*100).toFixed(1)+'%';
const fmtK = n => n>=1000?(n/1000).toFixed(1)+'K':n.toString();
const $ = id => document.getElementById(id);

function signalTag(s) {
  if (s.sc >= 70) return '<span class="tag tag-hot">ğŸ”¥ å¼ºå–</span>';
  if (s.sc >= 50) return '<span class="tag tag-rich">ğŸ’° å¯å–</span>';
  if (s.sc >= 30) return '<span class="tag tag-fair">ğŸ‘€ è§‚æœ›</span>';
  return '<span class="tag tag-cheap">ğŸ’¤ ä½IV</span>';
}

function scoreColor(sc) {
  if (sc >= 70) return '#f85149';
  if (sc >= 50) return '#d29922';
  if (sc >= 30) return '#3fb950';
  return '#484f58';
}

function ratioClass(r) {
  if (r == null) return 'gr';
  if (r > 1.5) return 'r';
  if (r > 1.2) return 'y';
  if (r > 1.0) return 'g';
  return 'gr';
}

// â”€â”€ Summary Cards â”€â”€
function renderSummary() {
  const syms = D.symbols;
  const avgIV = syms.reduce((a,s) => a+s.iv, 0) / syms.length;
  const top = syms[0];
  const best = [...syms].sort((a,b) => b.sc - a.sc)[0];
  const rich = syms.filter(s => s.ratio && s.ratio > 1.2).length;

  const cards = [
    {lb:'ç›‘æ§æ ‡çš„', val:syms.length, cls:'b'},
    {lb:'å¹³å‡ IV', val:fmtPct(avgIV), cls:'b'},
    {lb:'æœ€é«˜ IV', val:`${top.tk} ${fmtPct(top.iv)}`, cls:'r'},
    {lb:'æœ€ä½³æœºä¼š', val:`${best.tk} (${best.sc}åˆ†)`, cls:'y'},
    {lb:'IVåè´µ (>1.2x HV)', val:`${rich} ä¸ª`, cls: rich>0?'g':'gr'},
    {lb:'æ•°æ®æ—¥æœŸ', val:syms[0]?.dt||'â€”', cls:'gr'},
  ];
  $('summary').innerHTML = cards.map(c =>
    `<div class="card"><div class="lb">${c.lb}</div><div class="val ${c.cls}">${c.val}</div></div>`
  ).join('');
}

// â”€â”€ Scanner Table â”€â”€
let sortCol = 'sc', sortAsc = false;

function renderScanner() {
  const syms = [...D.symbols].sort((a,b) => {
    let va = a[sortCol], vb = b[sortCol];
    if (va == null) va = -999; if (vb == null) vb = -999;
    return sortAsc ? va - vb : vb - va;
  });

  $('scanner-body').innerHTML = syms.map(s => `
    <tr class="clickable" onclick="showDetail('${s.tk}')">
      <td><strong>${s.tk}</strong></td>
      <td>$${fmt(s.px,2)}</td>
      <td class="${s.iv>0.6?'r':s.iv>0.4?'y':''}"><strong>${fmtPct(s.iv)}</strong></td>
      <td>${fmtPct(s.hv20)}</td>
      <td class="${ratioClass(s.ratio)}"><strong>${s.ratio!=null?s.ratio.toFixed(2):'â€”'}</strong></td>
      <td>${s.pct!=null?s.pct.toFixed(0)+'%':'â€”'}</td>
      <td>${s.dte||'â€”'}</td>
      <td><div class="score-bar"><div class="score-fill" style="width:${s.sc}%;background:${scoreColor(s.sc)}"></div></div>${s.sc}</td>
      <td>${signalTag(s)}</td>
    </tr>
  `).join('');

  // Update header arrows
  document.querySelectorAll('#scanner th').forEach(th => {
    const col = th.dataset.col;
    const arrow = col === sortCol ? (sortAsc ? ' â†‘' : ' â†“') : '';
    th.querySelector('.arrow')?.remove();
    if (arrow) th.insertAdjacentHTML('beforeend', `<span class="arrow">${arrow}</span>`);
  });
}

document.querySelectorAll('#scanner th[data-col]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if (sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = false; }
    renderScanner();
  });
});

// â”€â”€ IV Bar Chart â”€â”€
let barChart;
function renderBarChart() {
  const syms = [...D.symbols].sort((a,b) => a.iv - b.iv);
  const ctx = $('ivBarChart').getContext('2d');
  barChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: syms.map(s => s.tk),
      datasets: [
        {label:'ATM IV', data:syms.map(s=>s.iv*100), backgroundColor:syms.map(s=>s.iv>0.6?'#f8514980':s.iv>0.4?'#d2992280':'#3fb95080'), borderColor:syms.map(s=>s.iv>0.6?'#f85149':s.iv>0.4?'#d29922':'#3fb950'), borderWidth:1},
        {label:'HV20', data:syms.map(s=>s.hv20?s.hv20*100:0), backgroundColor:'#58a6ff40', borderColor:'#58a6ff', borderWidth:1},
      ]
    },
    options: {
      indexAxis:'y',
      responsive:true, maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#8b949e',font:{size:11}}}},
      scales:{
        x:{grid:{color:'#21262d'},ticks:{color:'#8b949e',callback:v=>v+'%'}},
        y:{grid:{display:false},ticks:{color:'#c9d1d9',font:{size:12}}}
      }
    }
  });
}

// â”€â”€ Detail Panel â”€â”€
let hvChart, smileChart;

function showDetail(tk) {
  const s = D.symbols.find(x => x.tk === tk);
  if (!s) return;

  $('detail').style.display = 'block';
  $('detail-title').textContent = `${tk} â€” $${fmt(s.px,2)}`;

  // Info cards
  const items = [
    {lb:'ATM IV', val:fmtPct(s.iv), cls:s.iv>0.6?'r':s.iv>0.4?'y':'g'},
    {lb:'Call IV', val:fmtPct(s.civ), cls:'b'},
    {lb:'Put IV', val:fmtPct(s.piv), cls:'b'},
    {lb:'HV20', val:fmtPct(s.hv20), cls:'gr'},
    {lb:'HV50', val:fmtPct(s.hv50), cls:'gr'},
    {lb:'IV/HV20', val:s.ratio!=null?s.ratio.toFixed(2):'â€”', cls:ratioClass(s.ratio)},
    {lb:'IV %ile', val:s.pct!=null?s.pct.toFixed(0)+'%':'â€”', cls:s.pct>70?'r':s.pct>50?'y':'gr'},
    {lb:'æœºä¼šè¯„åˆ†', val:s.sc+'/100', cls:s.sc>=70?'r':s.sc>=50?'y':'g'},
    {lb:'DTE', val:s.dte||'â€”', cls:'b'},
    {lb:'åˆ°æœŸæ—¥', val:s.exp||'â€”', cls:'gr'},
  ];
  $('detail-cards').innerHTML = items.map(c =>
    `<div class="card"><div class="lb">${c.lb}</div><div class="val ${c.cls}">${c.val}</div></div>`
  ).join('');

  // HV Chart
  if (hvChart) hvChart.destroy();
  if (s.hvc.length > 0) {
    hvChart = new Chart($('hvChart').getContext('2d'), {
      type:'line',
      data:{
        labels: s.hvc.map(x=>x.d.slice(5)),
        datasets:[
          {label:'HV20', data:s.hvc.map(x=>x.h20?x.h20*100:null), borderColor:'#58a6ff', borderWidth:1.5, pointRadius:0, tension:0.3},
          {label:'HV50', data:s.hvc.map(x=>x.h50?x.h50*100:null), borderColor:'#8b949e', borderWidth:1, pointRadius:0, tension:0.3, borderDash:[4,4]},
          {label:'Current IV', data:s.hvc.map(()=>s.iv*100), borderColor:'#f85149', borderWidth:1, pointRadius:0, borderDash:[8,4]},
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{title:{display:true,text:'HV èµ°åŠ¿ vs å½“å‰ IV',color:'#8b949e',font:{size:12}},legend:{labels:{color:'#8b949e',font:{size:10}}}},
        scales:{x:{grid:{color:'#21262d'},ticks:{color:'#8b949e',font:{size:9},maxTicksLimit:12}},y:{grid:{color:'#21262d'},ticks:{color:'#8b949e',callback:v=>v+'%'}}}
      }
    });
  }

  // IV Smile â€” also check near-term chain if main chain is empty
  if (smileChart) smileChart.destroy();
  let smileData = s.ch;
  if (smileData.length === 0 && D.near) {
    const nearMatch = D.near.find(n => n.tk === tk);
    if (nearMatch) smileData = nearMatch.ch;
  }
  const calls = smileData.filter(c=>c.t==='C'&&c.iv!=null);
  const puts = smileData.filter(c=>c.t==='P'&&c.iv!=null);
  if (calls.length > 0 || puts.length > 0) {
    $('smileChart').parentElement.style.display = '';
    const allStrikes = [...new Set(smileData.filter(c=>c.iv!=null).map(c=>c.s))].sort((a,b)=>a-b);
    const callMap = Object.fromEntries(calls.map(c=>[c.s, c.iv*100]));
    const putMap = Object.fromEntries(puts.map(c=>[c.s, c.iv*100]));
    smileChart = new Chart($('smileChart').getContext('2d'), {
      type:'line',
      data:{
        labels: allStrikes.map(s=>'$'+s),
        datasets:[
          {label:'Call IV', data:allStrikes.map(s=>callMap[s]||null), borderColor:'#3fb950', borderWidth:1.5, pointRadius:2, tension:0.3, spanGaps:true},
          {label:'Put IV', data:allStrikes.map(s=>putMap[s]||null), borderColor:'#f85149', borderWidth:1.5, pointRadius:2, tension:0.3, spanGaps:true},
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{
          title:{display:true,text:'IV Smile (æŒ‰ Strike)',color:'#8b949e',font:{size:12}},
          legend:{labels:{color:'#8b949e',font:{size:10}}},
          annotation: s.px ? {annotations:{stockPrice:{type:'line',xMin:'$'+s.px,xMax:'$'+s.px,borderColor:'#d29922',borderWidth:1,borderDash:[4,4]}}} : undefined
        },
        scales:{x:{grid:{color:'#21262d'},ticks:{color:'#8b949e',font:{size:9},maxTicksLimit:15}},y:{grid:{color:'#21262d'},ticks:{color:'#8b949e',callback:v=>v.toFixed(0)+'%'}}}
      }
    });
  } else {
    $('smileChart').parentElement.style.display = 'none';
  }

  // Chain table â€” use near-term chain as fallback
  let chainData = s.ch;
  if (chainData.length === 0 && D.near) {
    const nearMatch = D.near.find(n => n.tk === tk);
    if (nearMatch) chainData = nearMatch.ch;
  }
  $('chain-body').innerHTML = chainData.map(c => {
    const isATM = Math.abs(c.s - s.px) <= s.px * 0.02;
    const bg = isATM ? 'background:#1c2128' : '';
    return `<tr style="${bg}">
      <td class="${c.t==='C'?'g':'r'}">${c.t==='C'?'Call':'Put'}</td>
      <td><strong>$${c.s}</strong>${isATM?' â¬…ï¸':''}</td>
      <td>${c.iv!=null?(c.iv*100).toFixed(1)+'%':'â€”'}</td>
      <td>${c.d!=null?c.d.toFixed(3):'â€”'}</td>
      <td>${c.th!=null?c.th.toFixed(3):'â€”'}</td>
      <td>${c.v!=null?c.v.toFixed(3):'â€”'}</td>
      <td>${c.b!=null?'$'+c.b.toFixed(2):'â€”'}</td>
      <td>${c.a!=null?'$'+c.a.toFixed(2):'â€”'}</td>
      <td>${fmtK(c.vol)}</td>
      <td>${fmtK(c.oi)}</td>
    </tr>`;
  }).join('');

  $('detail').scrollIntoView({behavior:'smooth', block:'start'});
}

function closeDetail() {
  $('detail').style.display = 'none';
}

// â”€â”€ Tabs â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  $('scanner-tab').style.display = tab === 'scanner' ? '' : 'none';
  $('weekly').style.display = tab === 'weekly' ? '' : 'none';
  $('screener-tab').style.display = tab === 'screener' ? '' : 'none';
  if (tab === 'weekly' && !weeklyRendered) renderWeekly();
  if (tab === 'screener' && !screenerRendered) renderScreener();
}

// â”€â”€ Weekly Trading â”€â”€
let weeklyRendered = false;

function renderWeekly() {
  weeklyRendered = true;
  const near = D.near || [];
  if (!near.length) {
    $('weekly-content').innerHTML = '<p class="gr" style="padding:20px">æš‚æ— è¿‘æœŸæœŸæƒæ•°æ®ã€‚è¿è¡Œé‡‡é›†ååˆ·æ–°ã€‚</p>';
    return;
  }

  // Group by ticker
  const byTicker = {};
  near.forEach(n => {
    if (!byTicker[n.tk]) byTicker[n.tk] = [];
    byTicker[n.tk].push(n);
  });

  let html = '';
  for (const [tk, expiries] of Object.entries(byTicker)) {
    const px = expiries[0].px;
    html += `<div class="weekly-symbol">`;
    html += `<h3>${tk} <span class="gr">$${fmt(px,2)}</span></h3>`;

    // Term structure
    html += `<div class="term-struct">`;
    expiries.sort((a,b) => a.dte - b.dte);
    expiries.forEach(e => {
      const ivColor = e.atm_iv > 0.7 ? 'r' : e.atm_iv > 0.5 ? 'y' : 'g';
      html += `<div class="ts-item"><div class="ts-dte">${e.exp} (${e.dte}D)</div><div class="ts-iv ${ivColor}">${e.atm_iv ? (e.atm_iv*100).toFixed(1)+'%' : 'â€”'}</div></div>`;
    });
    html += `</div>`;

    expiries.forEach(e => {
      html += `<div class="weekly-expiry">`;
      html += `<h4>ğŸ“… ${e.exp} â€” DTE ${e.dte}</h4>`;
      html += `<div class="opp-grid">`;

      // CSP candidates â€” highlight best annualized return
      html += `<div class="opp-box"><h5>ğŸ”» Sell Put (CSP)</h5>`;
      if (e.csp && e.csp.length) {
        const cspAnns = e.csp.map(p => {
          const mid = p.m || ((p.b||0)+(p.a||0))/2;
          return e.dte > 0 ? mid / p.s * 365 / e.dte * 100 : 0;
        });
        const maxCspAnn = Math.max(...cspAnns);
        e.csp.forEach((p, i) => {
          const mid = p.m || ((p.b||0)+(p.a||0))/2;
          const ann = e.dte > 0 ? (mid / p.s * 365 / e.dte * 100).toFixed(0) : 'â€”';
          const wk = (mid * 100 / e.dte * 7).toFixed(0);
          const best = cspAnns[i] === maxCspAnn ? ' style="color:#3fb950;font-weight:700"' : '';
          html += `<div class="opp-row">
            <span class="strike">$${p.s}</span>
            <span class="meta">Î´${p.d?.toFixed(2)||'â€”'}</span>
            <span class="premium">$${mid.toFixed(2)}</span>
            <span class="ann"${best}>${ann}% ann</span>
            <span class="meta">$${wk}/wk</span>
          </div>`;
        });
      } else {
        html += '<div class="gr" style="font-size:12px;padding:8px 0">æ— åˆé€‚å€™é€‰</div>';
      }
      html += `</div>`;

      // CC candidates â€” highlight best annualized return
      html += `<div class="opp-box"><h5>ğŸ”º Sell Call (CC)</h5>`;
      if (e.cc && e.cc.length) {
        const ccAnns = e.cc.map(c => {
          const mid = c.m || ((c.b||0)+(c.a||0))/2;
          return e.dte > 0 && px ? mid / px * 365 / e.dte * 100 : 0;
        });
        const maxCcAnn = Math.max(...ccAnns);
        e.cc.forEach((c, i) => {
          const mid = c.m || ((c.b||0)+(c.a||0))/2;
          const ann = e.dte > 0 && px ? (mid / px * 365 / e.dte * 100).toFixed(0) : 'â€”';
          const wk = (mid * 100 / e.dte * 7).toFixed(0);
          const best = ccAnns[i] === maxCcAnn ? ' style="color:#3fb950;font-weight:700"' : '';
          html += `<div class="opp-row">
            <span class="strike">$${c.s}</span>
            <span class="meta">Î´${c.d?.toFixed(2)||'â€”'}</span>
            <span class="premium">$${mid.toFixed(2)}</span>
            <span class="ann"${best}>${ann}% ann</span>
            <span class="meta">$${wk}/wk</span>
          </div>`;
        });
      } else {
        html += '<div class="gr" style="font-size:12px;padding:8px 0">æ— åˆé€‚å€™é€‰</div>';
      }
      html += `</div></div></div>`;
    });

    html += `</div>`;
  }

  $('weekly-content').innerHTML = html;
}

// â”€â”€ Screener â”€â”€
let screenerRendered = false;
let scrSortCol = 'atm_iv', scrSortAsc = false;

function renderScreener() {
  screenerRendered = true;
  const scr = D.screener;
  if (!scr || !scr.results || !scr.results.length) {
    $('screener-body').innerHTML = '<tr><td colspan="8" class="gr" style="padding:20px;text-align:center">æš‚æ—  Screener æ•°æ®ã€‚è¿è¡Œ screener.py åé‡æ–°ç”Ÿæˆã€‚</td></tr>';
    return;
  }

  $('screener-meta').textContent = `æ•°æ®æ¥æº: yfinance Â· æ‰«æ ${scr.total_scanned} ä¸ªæ ‡çš„ï¼Œ${scr.total_with_data} ä¸ªæœ‰æ•°æ® Â· æ›´æ–°äº ${scr.ts}`;

  const minIV = parseFloat($('scr-min-iv').value);
  const maxPrice = parseFloat($('scr-max-price').value);
  const minOI = parseInt($('scr-min-oi').value);

  // Tracked tickers from IV Scanner
  const tracked = new Set(D.symbols.map(s => s.tk));

  let items = scr.results.filter(r =>
    r.atm_iv >= minIV && r.price <= maxPrice && r.open_interest >= minOI
  );

  items.sort((a, b) => {
    let va = a[scrSortCol], vb = b[scrSortCol];
    if (va == null) va = -999; if (vb == null) vb = -999;
    if (typeof va === 'string') return scrSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    return scrSortAsc ? va - vb : vb - va;
  });

  $('screener-body').innerHTML = items.map(r => {
    const isTracked = tracked.has(r.ticker);
    const signal = r.atm_iv >= 0.70 ? '<span class="tag tag-hot">ğŸ”¥ å¼ºå–</span>'
      : r.atm_iv >= 0.50 ? '<span class="tag tag-rich">ğŸ’° å¯å–</span>'
      : '<span class="tag tag-fair">ğŸ‘€ è§‚æœ›</span>';
    const status = isTracked
      ? '<span class="badge-tracked">ğŸ“Š ç²¾ç¡®è¿½è¸ª</span>'
      : '<span class="badge-new">ğŸ†• ä»… Screener</span>';
    return `<tr>
      <td><strong>${r.ticker}</strong></td>
      <td>$${r.price.toFixed(2)}</td>
      <td class="${r.atm_iv>0.7?'r':r.atm_iv>0.5?'y':''}"><strong>${r.atm_iv_pct}%</strong></td>
      <td>${r.open_interest>=1000?(r.open_interest/1000).toFixed(1)+'K':r.open_interest}</td>
      <td class="${r.csp_ann_pct>80?'g':r.csp_ann_pct>40?'y':''}">${r.csp_ann_pct}%</td>
      <td>${r.dte}</td>
      <td>${signal}</td>
      <td>${status}</td>
    </tr>`;
  }).join('');

  // Sort headers
  document.querySelectorAll('#screener-table th[data-scol]').forEach(th => {
    th.querySelector('.arrow')?.remove();
    if (th.dataset.scol === scrSortCol) {
      th.insertAdjacentHTML('beforeend', `<span class="arrow">${scrSortAsc?' â†‘':' â†“'}</span>`);
    }
  });
}

document.querySelectorAll('#screener-table th[data-scol]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.scol;
    if (scrSortCol === col) scrSortAsc = !scrSortAsc;
    else { scrSortCol = col; scrSortAsc = false; }
    renderScreener();
  });
});

// â”€â”€ Init â”€â”€
$('gen-time').textContent = D.ts;
renderSummary();
renderScanner();
renderBarChart();
</script>
</body>
</html>
